{
  "version": 3,
  "sources": ["../src/core.ts"],
  "sourcesContent": ["/// <reference path=\"./global.d.ts\" />\n\n// ---------------------------------------------------------------------------\n// Types\n// ---------------------------------------------------------------------------\n\nexport type ConsentCategory = 'necessary' | 'functional' | 'analytics' | 'marketing';\n\nexport type ConsentAction = 'accept_all' | 'reject_all' | 'custom' | 'gpc';\n\nexport interface ConsentConfig {\n  cookieName?: string;\n  cookieDomain?: string;\n  cookieExpiry?: number; // days\n  consentVersion?: string;\n  gtmId?: string;\n}\n\nexport interface ConsentState {\n  categories: Record<ConsentCategory, boolean>;\n  consentVersion: string;\n  timestamp: string;\n  gpc: boolean;\n}\n\nexport type UIState = 'hidden' | 'banner' | 'preferences';\n\nexport type ConsentChangeCallback = (state: ConsentState, action: ConsentAction) => void;\nexport type UIChangeCallback = (uiState: UIState) => void;\n\n// ---------------------------------------------------------------------------\n// Category \u2192 Consent Mode v2 mapping\n// ---------------------------------------------------------------------------\n\nconst CATEGORY_CONSENT_MAP: Record<ConsentCategory, string[]> = {\n  necessary: ['security_storage'],\n  functional: ['functionality_storage', 'personalization_storage'],\n  analytics: ['analytics_storage'],\n  marketing: ['ad_storage', 'ad_user_data', 'ad_personalization'],\n};\n\n// ---------------------------------------------------------------------------\n// Defaults\n// ---------------------------------------------------------------------------\n\nconst DEFAULT_CONFIG: Required<ConsentConfig> = {\n  cookieName: 'cc_consent',\n  cookieDomain: '',\n  cookieExpiry: 365,\n  consentVersion: '1',\n  gtmId: '',\n};\n\nconst DEFAULT_CATEGORIES: Record<ConsentCategory, boolean> = {\n  necessary: true,\n  functional: false,\n  analytics: false,\n  marketing: false,\n};\n\n// ---------------------------------------------------------------------------\n// State\n// ---------------------------------------------------------------------------\n\nlet config: Required<ConsentConfig> = { ...DEFAULT_CONFIG };\nlet state: ConsentState | null = null;\nlet uiState: UIState = 'hidden';\nconst consentListeners: Set<ConsentChangeCallback> = new Set();\nconst uiListeners: Set<UIChangeCallback> = new Set();\nlet initialized = false;\n\n// ---------------------------------------------------------------------------\n// SSR guard\n// ---------------------------------------------------------------------------\n\nconst isBrowser = typeof window !== 'undefined';\n\n// ---------------------------------------------------------------------------\n// gtag helper\n// ---------------------------------------------------------------------------\n\nfunction ensureGtag() {\n  if (!isBrowser) return;\n  window.dataLayer = window.dataLayer || [];\n  if (typeof window.gtag !== 'function') {\n    window.gtag = function gtag() {\n      // eslint-disable-next-line prefer-rest-params\n      window.dataLayer.push(arguments as unknown as Record<string, unknown>);\n    };\n  }\n}\n\nfunction pushConsentDefault(categories: Record<ConsentCategory, boolean>) {\n  ensureGtag();\n  const consentParams: Record<string, string> = {};\n  for (const [cat, types] of Object.entries(CATEGORY_CONSENT_MAP)) {\n    const granted = categories[cat as ConsentCategory];\n    for (const t of types) {\n      consentParams[t] = granted ? 'granted' : 'denied';\n    }\n  }\n  window.gtag('consent', 'default', consentParams);\n}\n\nfunction pushConsentUpdate(categories: Record<ConsentCategory, boolean>, action: ConsentAction) {\n  ensureGtag();\n  const consentParams: Record<string, string> = {};\n  for (const [cat, types] of Object.entries(CATEGORY_CONSENT_MAP)) {\n    const granted = categories[cat as ConsentCategory];\n    for (const t of types) {\n      consentParams[t] = granted ? 'granted' : 'denied';\n    }\n  }\n  window.gtag('consent', 'update', consentParams);\n\n  window.dataLayer.push({\n    event: 'consent_update',\n    consent_action: action,\n    consent_categories: { ...categories },\n  });\n}\n\n// ---------------------------------------------------------------------------\n// Cookie helpers\n// ---------------------------------------------------------------------------\n\nfunction readCookie(): ConsentState | null {\n  if (!isBrowser) return null;\n  const match = document.cookie.match(new RegExp(`(?:^|; )${config.cookieName}=([^;]*)`));\n  if (!match) return null;\n  try {\n    return JSON.parse(decodeURIComponent(match[1])) as ConsentState;\n  } catch {\n    return null;\n  }\n}\n\nfunction writeCookie(value: ConsentState) {\n  if (!isBrowser) return;\n  const encoded = encodeURIComponent(JSON.stringify(value));\n  const parts = [\n    `${config.cookieName}=${encoded}`,\n    `path=/`,\n    `max-age=${config.cookieExpiry * 86400}`,\n    `SameSite=Lax`,\n  ];\n  if (config.cookieDomain) parts.push(`domain=${config.cookieDomain}`);\n  if (location.protocol === 'https:') parts.push('Secure');\n  document.cookie = parts.join('; ');\n}\n\nfunction deleteCookie() {\n  if (!isBrowser) return;\n  const parts = [`${config.cookieName}=`, 'path=/', 'max-age=0', 'SameSite=Lax'];\n  if (config.cookieDomain) parts.push(`domain=${config.cookieDomain}`);\n  document.cookie = parts.join('; ');\n}\n\n// ---------------------------------------------------------------------------\n// Notification\n// ---------------------------------------------------------------------------\n\nfunction notifyConsentChange(action: ConsentAction) {\n  if (!state) return;\n  for (const cb of consentListeners) {\n    try { cb(state, action); } catch { /* consumer error */ }\n  }\n}\n\nfunction notifyUIChange() {\n  for (const cb of uiListeners) {\n    try { cb(uiState); } catch { /* consumer error */ }\n  }\n}\n\nfunction setUIState(next: UIState) {\n  if (uiState === next) return;\n  uiState = next;\n  notifyUIChange();\n}\n\n// ---------------------------------------------------------------------------\n// Public API\n// ---------------------------------------------------------------------------\n\nexport function init(userConfig: ConsentConfig = {}): ConsentState | null {\n  if (!isBrowser) return null;\n\n  config = { ...DEFAULT_CONFIG, ...userConfig };\n  ensureGtag();\n\n  // Check GPC\n  const gpc = !!navigator.globalPrivacyControl;\n\n  // Read existing cookie\n  const existing = readCookie();\n\n  if (gpc && !existing) {\n    // GPC: treat as reject-all, persist it\n    const categories = { ...DEFAULT_CATEGORIES, necessary: true };\n    state = {\n      categories,\n      consentVersion: config.consentVersion,\n      timestamp: new Date().toISOString(),\n      gpc: true,\n    };\n    pushConsentDefault(categories);\n    writeCookie(state);\n    initialized = true;\n    setUIState('hidden');\n    return state;\n  }\n\n  if (existing && existing.consentVersion === config.consentVersion) {\n    // Valid existing consent\n    state = existing;\n    pushConsentDefault(existing.categories);\n    initialized = true;\n    setUIState('hidden');\n    return state;\n  }\n\n  // No valid consent \u2014 set all denied, show banner\n  const denied = { ...DEFAULT_CATEGORIES };\n  pushConsentDefault(denied);\n  state = null;\n  initialized = true;\n  setUIState('banner');\n  return null;\n}\n\nexport function getConsent(): ConsentState | null {\n  return state ? { ...state, categories: { ...state.categories } } : null;\n}\n\nexport function getConfig(): Required<ConsentConfig> {\n  return { ...config };\n}\n\nexport function getUIState(): UIState {\n  return uiState;\n}\n\nexport function hasValidConsent(): boolean {\n  if (!state) return false;\n  return state.consentVersion === config.consentVersion;\n}\n\nexport function updateConsent(\n  categories: Partial<Record<ConsentCategory, boolean>>,\n  action: ConsentAction = 'custom',\n): ConsentState {\n  if (!isBrowser) throw new Error('updateConsent requires a browser environment');\n\n  const merged: Record<ConsentCategory, boolean> = {\n    necessary: true, // always granted\n    functional: categories.functional ?? false,\n    analytics: categories.analytics ?? false,\n    marketing: categories.marketing ?? false,\n  };\n\n  state = {\n    categories: merged,\n    consentVersion: config.consentVersion,\n    timestamp: new Date().toISOString(),\n    gpc: !!navigator.globalPrivacyControl,\n  };\n\n  writeCookie(state);\n  pushConsentUpdate(merged, action);\n  notifyConsentChange(action);\n  setUIState('hidden');\n  return { ...state, categories: { ...merged } };\n}\n\nexport function acceptAll(): ConsentState {\n  return updateConsent(\n    { necessary: true, functional: true, analytics: true, marketing: true },\n    'accept_all',\n  );\n}\n\nexport function rejectAll(): ConsentState {\n  return updateConsent(\n    { necessary: true, functional: false, analytics: false, marketing: false },\n    'reject_all',\n  );\n}\n\nexport function resetConsent(): void {\n  deleteCookie();\n  state = null;\n  if (isBrowser) {\n    pushConsentDefault(DEFAULT_CATEGORIES);\n  }\n  setUIState('banner');\n}\n\nexport function onConsentChange(callback: ConsentChangeCallback): () => void {\n  consentListeners.add(callback);\n  return () => { consentListeners.delete(callback); };\n}\n\nexport function onUIChange(callback: UIChangeCallback): () => void {\n  uiListeners.add(callback);\n  return () => { uiListeners.delete(callback); };\n}\n\n// UI state mutators\nexport function showBanner(): void { setUIState('banner'); }\nexport function showPreferences(): void { setUIState('preferences'); }\nexport function hideUI(): void { setUIState('hidden'); }\nexport function openManage(): void { setUIState('preferences'); }\n"],
  "mappings": "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",
  "names": ["CATEGORY_CONSENT_MAP", "DEFAULT_CONFIG", "DEFAULT_CATEGORIES", "config", "state", "uiState", "consentListeners", "uiListeners", "initialized", "isBrowser", "ensureGtag", "pushConsentDefault", "categories", "consentParams", "cat", "types", "granted", "t", "pushConsentUpdate", "action", "readCookie", "match", "writeCookie", "value", "encoded", "parts", "deleteCookie", "notifyConsentChange", "cb", "notifyUIChange", "setUIState", "next", "init", "userConfig", "gpc", "existing", "denied", "getConsent", "getConfig", "getUIState", "hasValidConsent", "updateConsent", "merged", "acceptAll", "rejectAll", "resetConsent", "onConsentChange", "callback", "onUIChange", "showBanner", "showPreferences", "hideUI", "openManage"]
}
